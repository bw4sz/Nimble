{
    "contents" : "---\ntitle: \"Simulated Data for Two Detection Methods for Observing Species Interactions\"\nauthor: \"Ben Weinstein\"\ndate: \"December 25, 2015\"\noutput: \n  html_document:\n    toc: True\n    keep_md: True\n    theme: spacelab\n    numbered_sections: True\n---\n\n#Summary\n\n```{r,echo=F,message=FALSE,warning=F}\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(gridExtra)\nrequire(knitr)\nlibrary(R2jags)\nrequire(reshape2)\nrequire(ggplot2)\nlibrary(scales)\nlibrary(dplyr)\nlibrary(boot)\nlibrary(bipartite)\nlibrary(igraph)\nopts_chunk$set(cache=F,fig.height = 5,fig.width = 11,warning=F,messages=F,echo=T)\n\nsource(\"Bayesian/BayesFunctions.R\")\n```\n\n\n```{r}\n#load(\"Simulation_2M.RData\")\n```\n\nThere is some underlying network of interactions between hummingbird species  i and plant species j. We observe these interactions using transects across elevation ranges and cameras at individual flowers. To combine these data to jointly estimate the importance of trait-matching and resources on interaction intensity we need a hierarchical occupancy model that accounts for 1) the difference in sampling effort between survey types, 2) The variable number of replicates per species, 3) The difference in detectability of interactions based on survey type. The occupancy model below uses months as our estimated latent state. There are two surveys per month, and a variable number of cameras for each flower, often with no cameras on a given flower in a month.\n\n# True Simulated values\n\nHummingbird Species =5\n\nPlant Species=6\n\nSurvey Periods = 50\n\nDetection Probability for Camera = 0.25\n\nDetection Probability for Transect = 0.6\n\nHummingbird species are connected by the following hyperpriors\n\n* intercept<-1\n\n* alpha_sigma<- 0.2\n\nEffect of Trait-matching\n\n* gamma1=-0.5\n\n* sigma_slope1<- 0.2\n\nEffect of Resources\n\n* gamma2=0\n\n* sigma_slope2<- 0.1\n\nInteraction effect of resources * traitmatch\n\n* gamma3=0.3\n\n* sigma_slope3<- 0.1\n\nBill sizes\nBill<-rpois(h_species,10)\n\nCorolla sizes\n\nCorolla<-rpois(plant_species,15)\n\nResources are scored as either 'High' or 'Low' and is modeled as rbinom(n=1,size=1,prob=0.5)\n\n```{r,eval=T}\nh_species=5\nplant_species=6\nTimes=24\ndetection_cam=0.25\ndetection_trans=0.6\n\n#Bill sizes\nBill<-rpois(h_species,10)\n\n#Corolla sizes\nCorolla<-rpois(plant_species,15)\n\n#Subtract both and take absolute value\ntraitmatch<-abs(sapply(Corolla,function(x) x - Bill))\n\n#fill out for each month\ntraitarray<-array(NA,dim=c(h_species,plant_species,Times))\n#fill for each month\nfor (x in 1:Times){\n  traitarray[,,x]<-traitmatch \n}\n\n#simulate some poisson distributed resource counts for each replicate\n#this will be same for each species to start with.\nresources<-array(NA,dim=c(h_species,plant_species,Times))\n\n#fill for each month\nfor (x in 1:Times){\n  resources[,,x]<-rbinom(1,1,0.25)  \n}\n\n#standardize predictors\n#resources<-array(data=scale(resources,center=TRUE,scale=TRUE),dim=c(h_species,plant_species,Times))\n\n#regression slope for trait-matching and resources\n\n#Intercept\nalpha_mu<-2\nalpha_sigma<- 0.05\n\n#trait match\nbeta1_mu=-0.5\nbeta1_sigma<- 0.05\n\n#resources\nbeta2_mu=0\nbeta2_sigma<- 0.05\n\n#Interaction\nbeta3_mu=0.75\nbeta3_sigma<- 0.05\n\n#loop through each species and plants\n\n#draw values from hierarcichal distributions\nbeta1<-rnorm(h_species,beta1_mu,beta1_sigma)\nbeta2<-rnorm(h_species,beta2_mu, beta2_sigma)\nbeta3<-rnorm(h_species,beta3_mu, beta3_sigma)\nalpha<-rnorm(h_species,alpha_mu,alpha_sigma)\n\nphi<-inv.logit(alpha + beta1 * traitarray + beta2*resources+beta3*traitarray*resources)\n\n#How many cameras for each flower during each time period?\ntrue_interactions<-array(data=sapply(phi,function(x){rbinom(1,1,prob=x)}),dim=c(h_species,plant_species,Times))\n\n#combine and melt into a single datafFrame\nmdat<-dcast(melt(list(y=true_interactions,traitmatch=traitarray,resources=resources)),Var1+Var2+Var3~L1)\ncolnames(mdat)<-c(\"Bird\",\"Plant\",\"Time\",\"resources\",\"traitmatch\",\"True_state\")\n\n##Observation models\ndat<-list()\nfor (x in 1:nrow(mdat)){\n  #for each bird plant combo in that time period\n    timedat<-mdat[x,]\n    #Transects\n    Y_Transect=rbinom(3,timedat$True_state,prob=detection_trans)\n    out<-data.frame(Bird=timedat$Bird,Plant=timedat$Plant,Time=timedat$Time,Y_Transect)\n    \n    #Cameras\n    cams<-rpois(1,1)\n    if(!cams==0){\n    Y_Camera=rbinom(cams,mdat$True_state[x],prob=detection_cam)\n    out<-rbind_all(list(out,data.frame(Bird=timedat$Bird,Plant=timedat$Plant,Time=timedat$Time,Y_Camera)))\n    }\n    \n    dat[[x]]<-out\n  }\n\nodat<-rbind_all(dat)\n\nmdat<-merge(mdat,odat,by=c(\"Bird\",\"Plant\",\"Time\"))\n#ARRANGE\nmdat <- mdat %>% arrange(Bird,Plant,Time)\n```\n\n# Observed Data\n\n```{r}\nmdatm<-melt(mdat,measure.vars = c(\"True_state\",\"Y_Camera\",\"Y_Transect\"))\n\n#label resource times\nmdatm$resources<-as.factor(mdatm$resources)\nlevels(mdatm$resources)<-c(\"Low\",\"High\")\nggplot(mdatm,aes(x=traitmatch,y=value,col=variable)) + geom_point(alpha=.5) + geom_smooth(method=\"glm\",method.args=list(family=\"binomial\"),linetype=\"dashed\",size=1.1) + ggtitle(\"Correlation in Simulated Data\") + labs(x=\"Difference in Bill and Corolla Length (mm)\",y=\"Probability of Interactions\",col=\"Observation Process\") + theme_bw() + facet_wrap(~resources)\n\n#traitmatch dataframe\nTraitmatch<-mdat %>% group_by(Bird,Plant) %>% summarize(v=unique(traitmatch)) %>% acast(Bird~Plant,value.var=\"v\")\nTimeResources<-mdat %>% group_by(Bird,Time,Plant) %>% summarize(v=unique(resources)) %>% acast(Bird~Plant~Time,value.var=\"v\",fill=0)\n\n#label survey type\nmdat$Survey_Type<-NA\nmdat$Survey_Type<-is.na(mdat$Y_Transect)\nmdat$Survey_Type<-as.factor(mdat$Survey_Type)\nlevels(mdat$Survey_Type)<-c(\"Transect\",\"Camera\")\n```\n\n#Hierarchical Occupancy Model\n\nFor hummingbird species i feeding on plant species j observed at time k and sampling event d. \n\nObservation Model\n\nTransects\n\n$$ Y_{Transect_{i,j,k,d}} \\sim Bernoulli(S_{i,j,k} * \\omega_{Transect})$$\n$$ \\omega_{Transect} <- \\phi_{Transect}* EffortTransect_k $$\n\nCameras\n\n$$ Y_{Camera_{i,j,k,d}} \\sim Binomial(S_{i,j,k} * \\omega_{Camera})$$\n$$ \\omega_{Camera} <- \\phi_{Camera} * EffortCamera_k $$\n\nProcess Model\n\n$$ S_{i,j,k} \\sim Binomial(\\rho_{i,j,k}) $$\n$$ logit(\\rho_{i,j,k}) = \\alpha_i + \\beta_{1,i} * Traitmatch_{i,j} + \\beta_{2,i} *Resources_{j,k} $$\n\n\n**Priors**\n\n$$ \\phi_{Camera} \\sim Uniform(0,1) $$\n$$ \\phi_{Transect} \\sim Uniform(0,1) $$\n$$\\alpha_i \\sim Normal(\\mu_\\alpha,\\tau_{\\alpha})$$\n$$\\beta_{1,i} \\sim Normal(\\mu_{\\beta_1},\\tau_{\\beta_1})$$\n$$\\beta_{2,i} \\sim Normal(\\mu_{\\beta_2},\\tau_{\\beta_2})$$\n\n**Hyperpriors**\n\nGroup Level Means\n\n$$\\mu_{\\beta_1} \\sim Normal(0,1.67)$$\n$$\\mu_{\\beta_2} \\sim Normal(0,1.67)$$\n$$ \\mu_{\\alpha} \\sim Normal(0,1.67)$$\n\nGroup Level Variance\n\n$$\\tau_{\\alpha} \\sim Uniform(0,100)$$\n$$\\tau_{\\beta_1} \\sim Uniform(0,100)$$\n$$\\tau_{\\beta_2} \\sim Uniform(0,100)$$\n\n# Analysis of observed data\n\n```{r,eval=T,strip.white=T}\n\n#Source model\nsource(\"Bayesian/NmixturePoissonRagged2m.R\")\n\n#print model\nwriteLines(readLines(\"Bayesian/NmixturePoissonRagged2m.R\"))\n\n#Input Data\nDat <- c('Yobs_camera','Yobs_transect','Birds','Bird','Plant','Time','Plants','Times','resources','Nobs','cam_surveys','trans_surveys','Traitmatch')\n\n#Inits\nInitStage <- function(){\n  #A blank Y matrix - all present\n  initY<-array(dim=c(Birds,Plants,Times),data=1)\n  list(S=initY)}\n\n#Parameters to track\nParsStage <- c(\"alpha\",\"beta1\",\"beta2\",\"beta3\",\"alpha_mu\",\"alpha_sigma\",\"beta1_mu\",\"beta1_sigma\",\"beta2_mu\",\"beta2_sigma\",\"beta3_mu\",\"beta3_sigma\",\"dtrans\",\"dcam\")\n\n#MCMC options\n\nni <- 10000  # number of draws from the posterior\nnt <- max(c(1,ni*.00001))  #thinning rate\nnb <- ni*.92 # number to discard for burn-in\nnc <- 2  # number of chains\n\n#Jags\n\n  Yobs_camera = mdat$Y_Camera\n  Yobs_transect = mdat$Y_Transect\n  Birds=max(mdat$Bird)\n  Bird=mdat$Bird\n  Plant=mdat$Plant\n  Time=mdat$Time\n  Plants=max(mdat$Plant)\n  Times=max(mdat$Time)\n  resources=TimeResources\n  Nobs=nrow(mdat)\n  cam_surveys=(mdat$Survey_Type==\"Camera\")*1\n  trans_surveys=(mdat$Survey_Type==\"Transect\")*1\n  Traitmatch=Traitmatch\n\n  system.time(m<-do.call(jags.parallel,list(Dat,InitStage,ParsStage,model.file=\"Bayesian/NmixturePoissonRagged2m.jags\",n.thin=nt, n.iter=ni,n.burnin=nb,n.chains=nc)))\n```\n\n```{r}\npars<-extract_par(m)\n```\n\n###Assess Convergence\n\n```{r,cache=FALSE,eval=TRUE,fig.width=11,fig.height=5}\n###Chains\nggplot(pars[pars$par %in% c(\"alpha\",\"beta1\",\"beta2\",\"beta3\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + facet_grid(par~species,scale=\"free\") + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Species Level Probability\")\n```\n\n```{r}\nggplot(pars[pars$par %in% c(\"dcam\",\"dtrans\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + facet_grid(~par,scale=\"free\") + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Detection Probability\")\n```\n\n```{r,fig.height=5,fig.width=11,eval=T}\nggplot(pars[pars$par %in% c(\"alpha_mu\",\"alpha_sigma\",\"beta1_mu\",\"beta2_mu\",\"beta3_mu\",\"beta1_sigma\",\"beta2_sigma\",\"beta3_sigma\"),],aes(x=Draw,y=estimate,col=as.factor(Chain))) + geom_line() + theme_bw() + labs(col=\"Chain\") + ggtitle(\"Group Level Regression\") + facet_wrap(~par,scales=\"free\")\n```\n\n###Posteriors\n\n```{r,cache=FALSE,fig.width=7,fig.height=13}\n###Posterior Distributions\np<-ggplot(pars[pars$par %in% c(\"alpha\",\"beta1\",\"beta2\",\"beta3\"),],aes(x=estimate)) + geom_histogram() + ggtitle(\"Estimate of parameters\") + facet_grid(species~par,scales=\"free\") + theme_bw() + ggtitle(\"Species Posteriors\")\n\n#Add true values\ntr<-melt(data.frame(species=1:h_species,alpha=alpha,beta1=beta1,beta2=beta2,beta3=beta3),id.var='species')\ncolnames(tr)<-c(\"species\",\"par\",\"value\")\npsim<-p + geom_vline(data=tr,aes(xintercept=value),col='red',linetype='dashed',size=1)\n#ggsave(\"Figures/SimulationPosteriors.jpg\",dpi=300,height=8,width=8)\n```\n\n```{r,cache=FALSE,eval=TRUE,fig.height=13,fig.width=10}\np<-ggplot(pars[pars$par %in% c(\"beta1_mu\",\"beta2_mu\",\"beta3_mu\",\"alpha_mu\",\"alpha_sigma\",\"beta1_sigma\",\"beta2_sigma\",\"beta3_sigma\",\"dcam\",\"dtrans\"),],aes(x=estimate)) + geom_histogram() + ggtitle(\"Hierarchical Posteriors\") + facet_wrap(~par,scale=\"free\",nrow=2) + theme_bw() \n\n#Add true values\ntr<-melt(list(beta1_mu=beta1_mu,beta3_mu=beta3_mu,beta2_mu=beta2_mu,alpha_mu=alpha_mu,alpha_sigma=alpha_sigma,beta1_sigma=beta1_sigma,beta3_sigma=beta3_sigma,beta2_sigma=beta2_sigma,dtrans=detection_trans,dcam=detection_cam))\n\ncolnames(tr)<-c(\"value\",\"par\")\n\npsim2<-p + geom_vline(data=tr,aes(xintercept=value),linetype='dashed',size=1,col=\"red\")\n#ggsave(\"Figures/SimulationH.jpg\",dpi=300,height=4,width=10)\n```\n\n```{r,echo=F,fig.height=13,fig.width=12}\nsuppressMessages(grid.arrange(psim,psim2,heights=c(.65,.45)))\n```\n\n###Predicted Relationship \n\n```{r,fig.height=4,fig.width=4}\ncastdf<-dcast(pars[pars$par %in% c(\"beta1_mu\",\"beta2_mu\",\"beta3_mu\",\"alpha_mu\"),], Chain + Draw~par,value.var=\"estimate\")\n\ntrajF<-function(alpha,beta1,beta2,beta3,x,resources){\n  indat<-data.frame(alpha,beta1,beta2,beta3)\n  \n  #fit regression for each input estimate\n  sampletraj<-list()\n  \n  for (y in 1:nrow(indat)){\n    v=inv.logit(indat$alpha[y] + indat$beta1[y] * x + indat$beta2[y] * resources + indat$beta3[y] * x * resources)\n    \n    sampletraj[[y]]<-data.frame(x=as.numeric(x),y=as.numeric(v))\n  }\n  \n  sample_all<-rbind_all(sampletraj)\n  \n  #Compute CI intervals\n  predy<-group_by(sample_all,x) %>% summarise(lower=quantile(y,0.025,na.rm=T),upper=quantile(y,0.975,na.rm=T),mean=mean(y,na.rm=T))\n}\n```\n\n#Predicted Relationship\n\n```{r}\npredy<-trajF(alpha=castdf$alpha_mu,beta1=castdf$beta1_mu,beta2=castdf$beta2_mu,beta3=castdf$beta3_mu,x=as.numeric(traitarray),resources = as.numeric(TimeResources))\n\norig<-trajF(alpha=rnorm(2000,alpha_mu,alpha_sigma),beta1=rnorm(2000,beta1_mu,beta1_sigma),beta2=rnorm(2000,beta2_mu,beta2_sigma),beta3=rnorm(2000,beta3_mu,beta3_sigma),x=as.numeric(traitarray),resources = as.numeric(TimeResources))\n\n#plot and compare to original data\nggplot(data=predy,aes(x=x)) + geom_point(data=mdat,aes(x=traitmatch,y=True_state),alpha=.5,size=.5)+ geom_ribbon(aes(ymin=lower,ymax=upper),alpha=0.3,fill=\"red\")  + geom_line(aes(y=mean),size=.8,col=\"red\",linetype=\"dashed\") + theme_bw() + ylab(\"Probability of interactions\") + geom_line(data=orig,aes(x=x,y=mean),col='black',size=1)+ xlab(\"Difference between Bill and Corolla Length\") + geom_line(data=orig,aes(x=x,y=upper),col='grey50',linetype='dashed',size=0.5) + geom_line(data=orig,aes(x=x,y=lower),col='grey50',linetype='dashed',size=0.5)\n```\n\n##With Interaction\n\n```{r}\npredH<-trajF(alpha=castdf$alpha_mu,beta1=castdf$beta1_mu,x=mdat[mdat$resources==1,\"traitmatch\"],resources=mdat[mdat$resources==1,\"resources\"],beta2=castdf$beta2_mu,beta3=castdf$beta3_mu)\n\npredL<-trajF(alpha=castdf$alpha_mu,beta1=castdf$beta1_mu,x=mdat[mdat$resources==0,\"traitmatch\"],resources=mdat[mdat$resources==0,\"resources\"],beta2=castdf$beta2_mu,beta3=castdf$beta3_mu)\n\npredhl<-melt(list(High=predH,Low=predL),id.vars=colnames(predH))\n\ncolnames(predhl)[5]<-\"BFlowerL\"\n\nmdat$BFlowerL<-factor(as.character(mdat$resources))\nlevels(mdat$BFlowerL)<-c(\"Low\",\"High\")\n\norig<-trajF(alpha=rnorm(2000,alpha_mu,alpha_sigma),beta1=rnorm(2000,beta1_mu,beta1_sigma),beta2=rnorm(2000,beta2_mu,beta2_sigma),beta3=rnorm(2000,beta3_mu,beta3_sigma),x=as.numeric(traitarray),resources = as.numeric(TimeResources))\n\nggplot(data=predhl,aes(x=x)) + geom_ribbon(aes(ymin=lower,ymax=upper,fill=BFlowerL),alpha=0.6)  + geom_line(aes(y=mean,col=BFlowerL),size=.8) + theme_bw() + ylab(\"Probability of Interaction\") + xlab(\"Difference between Bill and Corolla Length\") + labs(fill=\"Resource Availability\",col=\"Resource Availability\") + geom_line(data=orig,aes(x=x,y=upper),col='grey50',linetype='dashed',size=0.5) + geom_line(data=orig,aes(x=x,y=lower),col='grey50',linetype='dashed',size=0.5)\n```\n\nThe true data is plotted overtop the simulation relationship in black, and the predicted relationship in dashed red with pink CI intervals.\n\n```{r}\nsave.image(\"Simulation_2M.RData\")\n```\n",
    "created" : 1467062541447.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3775996493",
    "id" : "C8F550D9",
    "lastKnownWriteTime" : 1465510107,
    "path" : "~/NetworkPredict/TwoDetectSimulation.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "type" : "r_markdown"
}